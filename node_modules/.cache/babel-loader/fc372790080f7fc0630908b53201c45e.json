{"ast":null,"code":"'use strict';\n\nconst cleanPositionalOperators = require('../schema/cleanPositionalOperators');\n\nconst handleTimestampOption = require('../schema/handleTimestampOption');\n\nmodule.exports = applyTimestampsToChildren;\n/*!\n * ignore\n */\n\nfunction applyTimestampsToChildren(now, update, schema) {\n  if (update == null) {\n    return;\n  }\n\n  const keys = Object.keys(update);\n  let key;\n  let createdAt;\n  let updatedAt;\n  let timestamps;\n  let path;\n  const hasDollarKey = keys.length && keys[0].startsWith('$');\n\n  if (hasDollarKey) {\n    if (update.$push) {\n      for (key in update.$push) {\n        const $path = schema.path(key);\n\n        if (update.$push[key] && $path && $path.$isMongooseDocumentArray && $path.schema.options.timestamps) {\n          timestamps = $path.schema.options.timestamps;\n          createdAt = handleTimestampOption(timestamps, 'createdAt');\n          updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n\n          if (update.$push[key].$each) {\n            update.$push[key].$each.forEach(function (subdoc) {\n              if (updatedAt != null) {\n                subdoc[updatedAt] = now;\n              }\n\n              if (createdAt != null) {\n                subdoc[createdAt] = now;\n              }\n            });\n          } else {\n            if (updatedAt != null) {\n              update.$push[key][updatedAt] = now;\n            }\n\n            if (createdAt != null) {\n              update.$push[key][createdAt] = now;\n            }\n          }\n        }\n      }\n    }\n\n    if (update.$set != null) {\n      const keys = Object.keys(update.$set);\n\n      for (key of keys) {\n        // Replace positional operator `$` and array filters `$[]` and `$[.*]`\n        const keyToSearch = cleanPositionalOperators(key);\n        path = schema.path(keyToSearch);\n\n        if (!path) {\n          continue;\n        }\n\n        let parentSchemaType = null;\n        const pieces = keyToSearch.split('.');\n\n        for (let i = pieces.length - 1; i > 0; --i) {\n          const s = schema.path(pieces.slice(0, i).join('.'));\n\n          if (s != null && (s.$isMongooseDocumentArray || s.$isSingleNested)) {\n            parentSchemaType = s;\n            break;\n          }\n        }\n\n        if (Array.isArray(update.$set[key]) && path.$isMongooseDocumentArray) {\n          applyTimestampsToDocumentArray(update.$set[key], path, now);\n        } else if (update.$set[key] && path.$isSingleNested) {\n          applyTimestampsToSingleNested(update.$set[key], path, now);\n        } else if (parentSchemaType != null) {\n          timestamps = parentSchemaType.schema.options.timestamps;\n          createdAt = handleTimestampOption(timestamps, 'createdAt');\n          updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n\n          if (!timestamps || updatedAt == null) {\n            continue;\n          }\n\n          if (parentSchemaType.$isSingleNested) {\n            // Single nested is easy\n            update.$set[parentSchemaType.path + '.' + updatedAt] = now;\n            continue;\n          }\n\n          let childPath = key.substr(parentSchemaType.path.length + 1);\n\n          if (/^\\d+$/.test(childPath)) {\n            update.$set[parentSchemaType.path + '.' + childPath][updatedAt] = now;\n            continue;\n          }\n\n          const firstDot = childPath.indexOf('.');\n          childPath = firstDot !== -1 ? childPath.substr(0, firstDot) : childPath;\n          update.$set[parentSchemaType.path + '.' + childPath + '.' + updatedAt] = now;\n        } else if (path.schema != null && path.schema != schema && update.$set[key]) {\n          timestamps = path.schema.options.timestamps;\n          createdAt = handleTimestampOption(timestamps, 'createdAt');\n          updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n\n          if (!timestamps) {\n            continue;\n          }\n\n          if (updatedAt != null) {\n            update.$set[key][updatedAt] = now;\n          }\n\n          if (createdAt != null) {\n            update.$set[key][createdAt] = now;\n          }\n        }\n      }\n    }\n  } else {\n    const keys = Object.keys(update).filter(key => !key.startsWith('$'));\n\n    for (key of keys) {\n      // Replace positional operator `$` and array filters `$[]` and `$[.*]`\n      const keyToSearch = cleanPositionalOperators(key);\n      path = schema.path(keyToSearch);\n\n      if (!path) {\n        continue;\n      }\n\n      if (Array.isArray(update[key]) && path.$isMongooseDocumentArray) {\n        applyTimestampsToDocumentArray(update[key], path, now);\n      } else if (update[key] != null && path.$isSingleNested) {\n        applyTimestampsToSingleNested(update[key], path, now);\n      }\n    }\n  }\n}\n\nfunction applyTimestampsToDocumentArray(arr, schematype, now) {\n  const timestamps = schematype.schema.options.timestamps;\n\n  if (!timestamps) {\n    return;\n  }\n\n  const len = arr.length;\n  const createdAt = handleTimestampOption(timestamps, 'createdAt');\n  const updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n\n  for (let i = 0; i < len; ++i) {\n    if (updatedAt != null) {\n      arr[i][updatedAt] = now;\n    }\n\n    if (createdAt != null) {\n      arr[i][createdAt] = now;\n    }\n  }\n}\n\nfunction applyTimestampsToSingleNested(subdoc, schematype, now) {\n  const timestamps = schematype.schema.options.timestamps;\n\n  if (!timestamps) {\n    return;\n  }\n\n  const createdAt = handleTimestampOption(timestamps, 'createdAt');\n  const updatedAt = handleTimestampOption(timestamps, 'updatedAt');\n\n  if (updatedAt != null) {\n    subdoc[updatedAt] = now;\n  }\n\n  if (createdAt != null) {\n    subdoc[createdAt] = now;\n  }\n}","map":null,"metadata":{},"sourceType":"script"}